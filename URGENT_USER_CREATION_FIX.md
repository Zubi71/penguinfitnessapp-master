# URGENT: Fix User Creation Database Error

## Problem
You're getting "Database error creating new user" when trying to register users. This is caused by:

1. **Schema Inconsistency**: Two different `user_roles` table schemas exist
2. **Missing Environment Variables**: Service role key might not be set
3. **RLS Policy Issues**: Infinite recursion in user_roles policies

## Immediate Fix

### Step 1: Fix Database Schema
Run this SQL in your Supabase SQL Editor:

```sql
-- Fix user_roles table schema inconsistency
-- Drop the old table and recreate with correct schema
DROP TABLE IF EXISTS user_roles CASCADE;

-- Create the correct schema
CREATE TABLE public.user_roles (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id UUID REFERENCES auth.users ON DELETE CASCADE NOT NULL,
  role app_role NOT NULL,
  UNIQUE (user_id, role)
);

-- Add comment
COMMENT ON TABLE public.user_roles IS 'Application roles for each user.';

-- Create indexes
CREATE INDEX IF NOT EXISTS idx_user_roles_user_id ON public.user_roles(user_id);
CREATE INDEX IF NOT EXISTS idx_user_roles_role ON public.user_roles(role);

-- Enable RLS
ALTER TABLE public.user_roles ENABLE ROW LEVEL SECURITY;

-- Create policies (without infinite recursion)
DROP POLICY IF EXISTS "Users can view their own role" ON public.user_roles;
DROP POLICY IF EXISTS "Users can insert their own role" ON public.user_roles;
DROP POLICY IF EXISTS "Users can update their own role" ON public.user_roles;
DROP POLICY IF EXISTS "Admins can manage all roles" ON public.user_roles;

CREATE POLICY "Users can view their own role" ON public.user_roles
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert their own role" ON public.user_roles
  FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own role" ON public.user_roles
  FOR UPDATE USING (auth.uid() = user_id) WITH CHECK (auth.uid() = user_id);

-- Grant permissions
GRANT ALL ON public.user_roles TO service_role;
GRANT SELECT, INSERT, UPDATE ON public.user_roles TO authenticated;
```

### Step 2: Check Environment Variables
Create a `.env.local` file in your project root with:

```env
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
NEXT_PUBLIC_SITE_URL=http://localhost:3000
```

### Step 3: Test User Creation
After applying the fixes:
1. Restart your development server: `npm run dev`
2. Try registering a new user
3. Check the browser console and server logs for any remaining errors

## Root Cause Analysis

The error was caused by:
1. **Schema Mismatch**: The `user_roles` table had conflicting schemas between migration files
2. **RLS Infinite Recursion**: The admin policy was querying the same table it was protecting
3. **Missing Environment Variables**: Service role key might not be properly configured

## Prevention
- Always use consistent schemas across migration files
- Avoid RLS policies that query the same table they protect
- Ensure all required environment variables are set
- Test user registration after any database schema changes

## Files Modified
- `fix-user-roles-schema.sql` - Database schema fix
- `fix-user-roles-urgent.sql` - Quick RLS policy fix
- `URGENT_USER_CREATION_FIX.md` - This documentation
